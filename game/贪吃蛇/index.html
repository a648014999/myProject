<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <style>
        #canvas {
            background: yellow;
            box-shadow: 0 5px 40px black;
        }
    </style>
</head>

<body>
    <canvas id="canvas" width="800" height="500"></canvas>
</body>
<script>
    window.focus();
</script>
<script>
    var canvas = document.getElementById('canvas');
    var context = canvas.getContext('2d');

    //构造对象方块
    function Rect(x, y, w, h, color) {
        this.x = x;
        this.y = y;
        this.w = w;
        this.h = h;
        this.color = color;
    }
    //画方块的方法
    Rect.prototype.draw = function () {
        context.beginPath();
        context.fillStyle = this.color;
        context.rect(this.x, this.y, this.w, this.h);
        context.fill();
        context.stroke();
    }

    //构造对象蛇
    function Snake() {

        //定义一个空数组存放组成整蛇的方块对象
        var snakeArray = [];

        var HistorDir = "";
        //画出7个方块，设置成灰色
        for (var i = 0; i < 6; i++) {
            var rect = new Rect(i * 20, 0, 20, 20, "gray");
            //之所以用splice（往前加）而不是用push（往后加），是为了让蛇头出现在数组第一个位置
            snakeArray.splice(0, 0, rect);
        }

        //把数组第一个作为蛇头，蛇头设成红色
        var head = snakeArray[0];
        head.color = "red";

        //此处将两个后面常用的东西定为属性，方便后面调用
        this.head = snakeArray[0]; //蛇头
        this.snakeArray = snakeArray; //整蛇数组

        //给定初始位置向右(同keyCode右箭头)
        this.direction = "R";
    }
    //画蛇的方法
    Snake.prototype.draw = function () {
        for (var i = 0; i < this.snakeArray.length; i++) {
            this.snakeArray[i].draw();
        }
    }
    //蛇移动的方法
    // var lastDir = "";
    Snake.prototype.move = function () {

        //此处是核心部分，蛇的 移动方式
        //1、画一个灰色的方块，位置与蛇头重叠
        //2、将这个方块插到数组中蛇头后面一个的位置
        //3、砍去末尾的方块
        //4、将蛇头向设定方向移动一格
        var rect = new Rect(this.head.x, this.head.y, this.head.w, this.head.h, "gray");
        this.snakeArray.splice(1, 0, rect);

        //判断是否吃到食物，isEat判定函数写在最后了
        //吃到则食物重新给位置，不砍去最后一节，即蛇变长
        //没吃到则末尾砍掉一节，即蛇长度不变
        if (isEat()) {
            food = new getRandomFood();
        } else {
            this.snakeArray.pop();
        }

        //限制蛇的反方向
        if (this.direction == "L" && this.HistorDir == "R") {
            this.direction = "R";
            // console.log(" 限制蛇的方向,蛇当前方向：" + this.direction);
        } else if (this.direction == "R" && this.HistorDir == "L") {

            this.direction = "L";
            // console.log(" 限制蛇的方向,蛇当前方向：" + this.direction);
        } else if (this.direction == "U" && this.HistorDir == "D") {
            this.direction = "D";
            // console.log(" 限制蛇的方向,蛇当前方向：" + this.direction);
        } else if (this.direction == "D" && this.HistorDir == "U") {
            this.direction = "U";
            // console.log(" 限制蛇的方向,蛇当前方向：" + this.direction);
        }

        //设置蛇头的运动方向，37 左，38 上，39 右，40 下
        // console.log("move调用，当前蛇的方向：" + this.direction);
        // console.log("       历史方向记录：" + this.HistorDir);

        switch (this.direction) {
            case "L":
                this.head.x -= this.head.w
                break;
            case "U":
                this.head.y -= this.head.h
                break;
            case "R":
                this.head.x += this.head.w
                break;
            case "D":
                this.head.y += this.head.h
                break;
            default:
                break;
        }

        //记录历史方向
        if (this.direction == "L") {
            this.HistorDir = this.direction;
        } else if (this.direction == "R") {
            this.HistorDir = this.direction;
        } else if (this.direction == "U") {
            this.HistorDir = this.direction;
        } else if (this.direction == "D") {
            this.HistorDir = this.direction;
        }

        // gameover判定
        // 撞墙
        // console.log("width:"+canvas.width+"  height:"+canvas.height+"  "+this.head.x+":"+this.head.y);
        if (this.head.x >= canvas.width || this.head.x < 0 || this.head.y >= canvas.height || this.head.y < 0) {
            gameOver("哦！你撞墙了！是否重来呢？");
        }

        // 撞自己，循环从1开始，避开蛇头与蛇头比较的情况
        for (let i = 1; i < this.snakeArray.length; i++) {
            if (this.snakeArray[i].x == this.head.x && this.snakeArray[i].y == this.head.y) {
                // console.log("身体第几个方块：" + i + " 身体的x:" + this.snakeArray[i].x + " 身体的y：" +
                //     this.snakeArray[i].y + "  头部的x：" + this.head.x + " 头部的y：" + this.head.y);
                gameOver("兄弟，你撞到你自己了。重来？");
            }
        }
    }

    //画出初始的蛇
    var snake = new Snake()
    snake.draw();

    //画出初始的食物
    var food = new getRandomFood()
    var speed = 100;
    var foodcount = 0;
    //定时器
    var timer = setInterval(gameStart, speed)

    //游戏开始
    function gameStart() {
        context.clearRect(0, 0, canvas.width, canvas.height);
        scorecard();
        food.draw();
        snake.move();
        snake.draw();
    }

    //游戏结束
    function gameOver(msg) {
        // clearInterval(timer);

        if (confirm(msg)) {
            clearInterval(timer);
            initData(); //初始化数据
            timer = setInterval(gameStart, speed)
        } else {
            location.href = "xxx.com";
            // window.close();

        }
    }

    //键盘事件，获取用户输入的方向
    document.onkeydown = function (e) {

        var ev = e || window.event;

        if (ev.keyCode == 37) {
            var curDir = "L";
            snake.direction = curDir;
        } else if (ev.keyCode == 38) {
            var curDir = "U";
            snake.direction = curDir;
        } else if (ev.keyCode == 39) {
            var curDir = "R";
            snake.direction = curDir;
        } else if (ev.keyCode == 40) {
            var curDir = "D";
            snake.direction = curDir;
        }
        // console.log("  用户当前输入："+curDir);


        ev.preventDefault();
    }

    //随机函数，获得[min,max]范围的值
    function getNumberInRange(min, max) {
        var range = max - min;
        var r = Math.random();
        return Math.round(r * range + min)
    }

    //构建食物对象
    function getRandomFood() {

        //判定食物是否出现在蛇身上，如果是重合，则重新生成一遍
        var isOnSnake = true;

        //设置食物出现的随机位置
        while (isOnSnake) {
            //执行后先将判定条件设置为false，如果判定不重合，则不会再执行下列语句
            isOnSnake = false;
            var indexX = getNumberInRange(0, canvas.width / 20 - 1);
            var indexY = getNumberInRange(0, canvas.height / 20 - 1);
            var rect = new Rect(indexX * 20, indexY * 20, 20, 20, "green");
            for (var i = 0; i < snake.snakeArray.length; i++) {
                if (snake.snakeArray[i].x == rect.x && snake.snakeArray[i].y == rect.y) {
                    //如果判定重合，将其设置为true，使随机数重给
                    isOnSnake = true;
                    break;
                }
            }
        }
        //返回rect，使得实例化对象food有draw的方法
        return rect;
    }
    var gameLv = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
    var gameDiff = 15;
    var scorePositionX = 0;
    var scorePositionY = 30;
    var level = 1;

    function initData() {
        snake = new Snake(); //初始化蛇的位置 以及 食物的位置
        food = new getRandomFood();
        level = 1;
        speed = 100;
        foodcount = 0;
    }

    function levelshow(){
        console.log("关卡："+level);
        if (level == 2) {
            alert("第一关也没啥难的");
        }
        if (level == 3) {
            alert("第二关勉勉强强啦");
        }
        if (level == 4) {
            alert("还行，通过了第三关");
        }
        if (level == 5) {
            alert("勉勉强强啦，第四关而已");
        }
        if (level == 6) {
            alert("哇 你好厉害 居然通过了第五关");
        }
    }
    // levelshow();
    function scorecard() {
        // for (var i in gameLv) {
        //     if (foodcount == gameLv[i]) {
        //         console.log(i);
                
        //         break;
        //     }
        // }
        context.beginPath();
        context.font = "16px Courier New";
        context.fillStyle = "black";
        context.fillText("当前关卡:" + level, scorePositionX, scorePositionY);
        context.fillText("吃的食物数量:" + foodcount, scorePositionX, scorePositionY + 30);

    }
    //判定吃到食物，即蛇头坐标与食物坐标重合
    function isEat() {

        if (snake.head.x == food.x && snake.head.y == food.y) {
            foodcount++;

            for (var i in gameLv) {
                if (foodcount == gameLv[i]) {
                    speed -= gameDiff;
                    level = parseInt(i) + 2;
                    // levelshow();
                    if (speed < 10) {
                        speed = 1;
                    }
                }
            }
            // if(foodcount%2==0){

            console.log(foodcount + ":" + speed);
            clearInterval(timer);
            timer = setInterval(gameStart, speed)

            // }
            return true;
        } else {
            return false;
        }
    }
</script>